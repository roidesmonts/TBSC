define(["jquery","lmd/core/auth","lmd/core/service"],function($,auth,service){return{get:function(options){if(typeof options==="undefined")options={};var defer=$.Deferred();auth.loadUser().done(function(){var size=options.width+"x"+options.height;if(typeof auth.user.avatar!=="undefined"&&typeof auth.user.avatar[size]!=="undefined"&&typeof auth.user.avatar[size].src!=="undefined")defer.resolve(auth.user.avatar[size].src);else{if(typeof auth.user.avatar_id==="undefined"||auth.user.avatar_id===null)return;
var data={id:auth.user.avatar_id,hdpi:typeof window.devicePixelRatio!=="undefined"&&window.devicePixelRatio>1.5,width:0,height:0};$.extend(data,options);service.get("illustration",1,data,{dataType:"jsonp"}).done(function(data){if(typeof data.src!=="undefined"){defer.resolve(data.src);if(typeof auth.user.avatar==="undefined")auth.user.avatar={};auth.user.avatar[size]={src:data.src};auth.update()}})}});return defer.promise()}}});
