define(["jquery","lmd/core/storage","lib/jquery/plugin/jquery.cookie","lmd/core/service"],function($,storage,jqueryCookie,service){var auth={STORAGE_KEY:"user",JOURNALISTES_STORAGE_KEY:"journalistes",COOKIE_USER_ID:"tdb_user_id",COOKIE_ALM:"alm",COOKIE_WORDPRESS:"wordpress_domain",COOKIE_EDUCATION:"educ_partenaires",user:null,_loadUserDeferred:null,_loadUserServicesDeferred:null,authenticated:false,checkAuthentication:function(){this.authenticated=$.cookie(this.COOKIE_USER_ID)!==null;if(this.authenticated===
false)this.clearCache();return this.authenticated},refresh:function(){return this.loadUser(true)},update:function(){this._putInCache()},login:function(params,jsonp){var settings={};if(typeof jsonp==="boolean")settings.dataType="jsonp";return service.get("auth/login",1,params,settings)},register:function(params,jsonp){var settings={};if(typeof jsonp==="boolean")settings.dataType="jsonp";return service.get("auth/register",1,params,settings)},confirm:function(params,jsonp){var settings={};if(typeof jsonp===
"boolean")settings.dataType="jsonp";return service.get("auth/confirmation",1,params,settings)},resetPassword:function(params,jsonp){var settings={};if(typeof jsonp==="boolean")settings.dataType="jsonp";return service.get("auth/password/reset",1,params,settings)},changePassword:function(params,jsonp){var settings={};if(typeof jsonp==="boolean")settings.dataType="jsonp";return service.get("auth/password/change",1,params,settings)},logout:function(){this.clearCache();return service.get("auth/logout",
1,null,{dataType:"jsonp"}).done($.proxy(this.clearCache,this))},loadUser:function(refresh){var firstLoad=false;if(this._loadUserDeferred===null||refresh){this._loadUserDeferred=$.Deferred();firstLoad=true}if(this._loadUserServicesDeferred===null||refresh)this._loadUserServicesDeferred=$.Deferred();this.checkAuthentication();if(this.authenticated&&(firstLoad||refresh)){if(storage.isSupported&&!refresh){var user=storage.get(this.STORAGE_KEY);if(user!==null){var userId=this._getUserIdAlm();if(user.id==
userId||userId===null){this.user=user;this._loadUserDeferred.resolve();if(!$.cookie(this.COOKIE_WORDPRESS)&&auth.user.services.indexOf("blog"))this.majServices(true);else this._loadUserServicesDeferred.resolve();return this._loadUserDeferred.promise()}}}var xhr=service.get("auth/user",1,null,{dataType:"jsonp"}).done($.proxy(this._loadUserCallback,this));var xhr=service.get("auth/majServices",1,null,{dataType:"jsonp"}).done($.proxy(this._loadUserServicesCallback,this))}if(!this.authenticated){this._loadUserDeferred.resolve();
this._loadUserServicesDeferred.resolve()}return this._loadUserDeferred.promise()},majServices:function(refresh){if(refresh)var xhr=service.get("auth/majServices",1,null,{dataType:"jsonp"}).done($.proxy(this._loadUserServicesCallback,this));else{this.loadUser(refresh);return this._loadUserServicesDeferred.promise()}},clearCache:function(){storage.remove(this.STORAGE_KEY);storage.remove(this.JOURNALISTES_STORAGE_KEY)},isUserEducation:function(){return this.checkAuthentication()&&$.cookie(this.COOKIE_EDUCATION)},
_getUserIdAlm:function(){var cookieAlm=$.cookie(this.COOKIE_ALM);if(cookieAlm===null)return null;var tab=cookieAlm.split("-");if(tab.length>2)return parseInt(tab[tab.length-2]);else return null},_loadUserCallback:function(data){if(typeof data==="object"&&typeof data.user==="object"){this.user=data.user;this._putInCache();this._loadUserDeferred.resolve()}else this._loadUserDeferred.reject()},_loadUserServicesCallback:function(data){if(typeof data==="object"&&data.succes)this._loadUserServicesDeferred.resolve();
else this._loadUserServicesDeferred.reject()},_putInCache:function(){if(storage.isSupported)storage.set(this.STORAGE_KEY,this.user,18E5,false)}};auth.authenticated=auth.checkAuthentication();return auth});
